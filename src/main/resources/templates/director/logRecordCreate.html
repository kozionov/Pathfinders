<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Журнал</title>
    <style type="text/css">
        body {
            padding: 50px;
        }

        .users {
            border: 1px solid steelblue;
            width: 300px;
            border-collapse: collapse;
        }

        .users tr td, th {
            padding: 5px;
            border: 1px solid steelblue;
        }

        .users td:last-child, td:first-child {
            width: 50px;
        }
    </style>
    <script src="../static/script.js" th:src="@{/script.js}"></script>
    <script
            src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"></script>
    <script>
        window.onload = async () => {
            const scores = await fetchAllScores();

            const usersTableBody = document.getElementById("usersTableBody")

            const response = await fetch("/api/users");
            const users = await response.json();
            users.forEach(user => {
                const row = usersTableBody.insertRow()
                row.id = "userRow" + user.id

                row.insertCell(0).innerHTML = user.id;

                const cell2 = row.insertCell(1);
                const detailsLink = document.createElement('a');
                detailsLink.innerHTML = user.name + " " + user.surname;
                detailsLink.href = "/user?id=" + user.id;
                cell2.appendChild(detailsLink);


                const cell3 = row.insertCell(2);
                const scoresBox = document.createElement('div');
                scores.forEach(score => {
                    var newCheckBox = document.createElement('input');
                    newCheckBox.type = 'checkbox';
                    newCheckBox.id = user.id +'/'+ score.id;
                    newCheckBox.value = score.val;
                    scoresBox.appendChild(newCheckBox);
                });

                cell3.appendChild(scoresBox);
            });
        }

        async function saveLogRecord() {
                var date = new Date($('#date-input').val());
                console.log(date);
                var log = {
                    classDate: date,
                    records: []
                };
             $('table tr').each(function(row){
                let userId;
                let scoreSum = 0;
                $(this).find('td').each(function(cell){
                    console.log('Строка ' + row + ', ячейка ' + cell + ', значение: ' + $(this).html());
                    if(cell===0){
                        console.log('userId = '+  $(this).html());
                        userId = $(this).html();
                    } else if(cell===2){
                            $(this).children().first().children().each(function(checkbox){
                                if($(this).is(":checked")){
                                    console.log('checked ' + $(this).attr('value'));
                                    scoreSum = scoreSum + parseInt($(this).attr('value'));
                                }
                            });

                            console.log('sum = ' + scoreSum + ' userId = ' + userId);
                            const record = { userId: userId,  scoreSum: scoreSum};
                            console.log('record = ' + JSON.stringify(record));
                            log.records.push({
                                "userId" : userId,
                                "scoreSum"   : scoreSum
                            });
                            console.log('log = ' + log);
                            console.log('log = ' + JSON.stringify(log));
                    }
                });
            });

            const urlParams = new URLSearchParams(window.location.search);
            const userIdParam = urlParams.get('id');
            const response = await fetch("/api/logs/"+userIdParam, {
                method: 'PUT',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(log)});
            const status = await response.status
            if (status === 200) {
                window.location.replace("/")
            }
        }

    </script>
</head>
<body>
<a href="#" th:href="@{/logout}">Log Out</a>
<h3>Клуб:</h3>

<h3>Users:</h3>

<input type="date" id="date-input">

<table class="users">
    <thead>
    <tr>
        <th>id</th>
        <th>Имя</th>
        <th>Отметки</th>
    </tr>
    </thead>
    <tbody id="usersTableBody">

    </tbody>
</table>

<br/>
<div class="row">
    <button type="button" onclick="saveLogRecord()">Сохранить</button>
    <a th:href="@{/}">
        <button type="button">Cancel</button>
    </a>
</div>
</body>
</html>