<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <div th:replace="fragments::head"></div>
    <script>
        var logId;
        var club;
        var gr

        window.onload = async () => {
            gr = [];
            gr.push(["Element", "Density", { role: "style" } ])

            console.log($('#pid').html())
            club = await fetchClubByUserId($('#pid').html());
            console.log("test" + club.id)
             const clubInfo = document.getElementById("clubInfo")
             const clubP = document.createElement('p');
             if(club.id!=null){
                clubP.innerHTML = club.name + " " + club.city;
             }
             clubInfo.appendChild(clubP);

             if(club.id==null){
                $('#addPathfinder').css("visibility", "hidden");
                $('#addRecords').css("visibility", "hidden");
             } else{
                $('#addPathfinder').css("visibility", "visible");
             }

             if(club.id!=null){
                $('#addClub').css("visibility", "hidden");
             } else{
                $('#addClub').css("visibility", "visible");
             }


            const logs = await fetchLogsByClubId(club.id);
            logId = logs[0].id;
             const records = await fetchRecordsByLogId(logs[0].id);

             const usersL = await fetchUsersByLogId(logs[0].id);

            const usersTableBody = document.getElementById("usersTableBody")

             if(usersL != null && usersL.length>0){
                $('#addRecords').css("visibility", "visible");
             } else{
                 $('#addRecords').css("visibility", "hidden");
             }

var tr = document.getElementById('table').tHead.children[0]

var i = 0;

            usersL.forEach(user => {
                    if(i==0){
                        records.forEach(rec => {
                            if(rec.userId==user.id){
                                console.log("+++ " + rec.classDate);
                               var th = document.createElement('th');
                                th.innerHTML = rec.classDate;
                                tr.appendChild(th);
                            }
                        });
                    i=i+1;
                    }

                const row = usersTableBody.insertRow()
                row.id = "userRow" + user.id


                row.insertCell(0).innerHTML = user.id;

                const cell2 = row.insertCell(1);
                const detailsLink = document.createElement('a');
                detailsLink.innerHTML = user.name + " " + user.surname;
<!--                detailsLink.href = "/user?id=" + user.id;-->
                cell2.appendChild(detailsLink);

                let scoresQ = 0;
                let m = 2;
                records.forEach(rec => {
                    if(rec.userId==user.id){
                        if (rec.scoreSum != null){
                        scoresQ = scoresQ + rec.scoreSum;
                        row.insertCell(m).innerHTML = rec.scoreSum;
                        m=m+1;
                        }
                    }
                });

               gr.push([ user.name + " " + user.surname, parseInt(scoresQ), "#b87333"])

            });

            console.log(gr)
            showGraph();
        }

        async function deleteUser(pointerEvent) {
            const userId = pointerEvent.currentTarget.id
                .replace("deleteButton", "")
            const response = await fetch("/api/users/" + userId, {
                method: "DELETE"
            });
            const result = await response;
            if (result.status === 200) {
                const row = document.getElementById("userRow" + userId);
                row.remove();
            }
        }

        function redirectToLogRecordCreate(){
            window.location.href = "/logRecord/create?id=" + logId;
        }
    </script>

</head>
<body>
<div th:replace="~{fragments :: top_panel}"></div>

<div style="display: none;"><p id="ppid">Roles: <span sec:authentication="principal.id" id="pid"> </span></p></div>

<h3>Клуб:</h3>
<div id="clubInfo">
</div>
<a th:href="@{/club/create}" type="button" id="addClub">
    <button class="btn btn-primary">Создать клуб</button>
</a> <br/>
<a th:href="@{/user/create}" type="button" id="addPathfinder">
    <button class="btn btn-primary">Добавить следопыта</button>
</a>
<h3>Журнал:</h3>

<table class="users" id="table">
    <thead>
    <tr>
        <th>id</th>
        <th>Имя</th>
    </tr>
    </thead>
    <tbody id="usersTableBody">

    </tbody>
</table>
<br/>

<a type="button" onclick="redirectToLogRecordCreate();" id="addRecords">
    <button class="btn btn-primary">Провести занятие</button>
</a>

<div id="chart_div"></div>

<div th:replace="~{fragments :: footer}"></div>
</body>
</html>